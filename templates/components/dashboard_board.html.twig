<section {{ attributes }}>
    <h2>Widgets</h2>

    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <form method="post" action="{{ path('dashboard_widget_add') }}">
            <input type="hidden" name="type" value="product_search">
            <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_add') }}">
            <button type="submit">Add product search</button>
        </form>
        <form method="post" action="{{ path('dashboard_widget_add') }}">
            <input type="hidden" name="type" value="brand_search">
            <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_add') }}">
            <button type="submit">Add brand search</button>
        </form>
        <form method="post" action="{{ path('dashboard_widget_add') }}">
            <input type="hidden" name="type" value="nutriscore_a_search">
            <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_add') }}">
            <button type="submit">Add NutriScore A finder</button>
        </form>
    </div>

    <p style="font-size: 0.9rem;">Drag and drop to reorder, then click "Save order".</p>

    <ul id="dashboard-widgets-list" style="list-style: none; padding: 0;">
        {% for widget in this.widgets %}
            <li data-widget-id="{{ widget.id }}" style="border: 1px solid #ccc; margin: 8px 0; padding: 10px;">
                <strong>{{ widget.type }}</strong> (#{{ widget.position }})

                <div style="margin-top: 8px;">
                    <form method="post" action="{{ path('dashboard_widget_configure', { widgetId: widget.id }) }}" style="display: inline-flex; gap: 8px;">
                        <label for="config-{{ widget.id }}">{{ widget.configField.label }}</label>
                        <input
                            name="{{ widget.configField.name }}"
                            id="config-{{ widget.id }}"
                            type="text"
                            placeholder="{{ widget.configField.placeholder }}"
                            value="{{ attribute(widget.configuration, widget.configField.name)|default('') }}"
                        >
                        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_configure_' ~ widget.id) }}">
                        <button type="submit">Save config</button>
                    </form>
                    <form method="post" action="{{ path('dashboard_widget_remove', { widgetId: widget.id }) }}" style="display: inline-block; margin-left: 8px;">
                        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_remove_' ~ widget.id) }}">
                        <button type="submit">Remove</button>
                    </form>
                </div>

                {% set hasPreviewConfig = (widget.type == 'brand_search' and widget.configuration.brand is defined and widget.configuration.brand is not empty)
                    or (widget.type != 'brand_search' and widget.configuration.query is defined and widget.configuration.query is not empty) %}
                {% if hasPreviewConfig %}
                    <div style="margin-top: 10px; background: #f9fafb; border: 1px solid #e5e7eb; padding: 8px;">
                        <p style="margin: 0 0 6px 0; font-size: 0.9rem;">
                            {% if widget.type == 'brand_search' %}
                                Brand results for "{{ widget.configuration.brand }}"
                            {% elseif widget.type == 'nutriscore_a_search' %}
                                NutriScore A results for "{{ widget.configuration.query }}"
                            {% else %}
                                Results for "{{ widget.configuration.query }}"
                            {% endif %}
                            {% if widget.degraded %}
                                <span style="color: #b45309;">(degraded: {{ widget.degradationReason }})</span>
                            {% endif %}
                        </p>

                        <ul style="margin: 0; padding-left: 18px;">
                            {% for product in widget.preview %}
                                <li>{{ product.name }}{% if product.brand %} - {{ product.brand }}{% endif %}{% if product.nutriScore %} (NutriScore: {{ product.nutriScore|upper }}){% endif %}</li>
                            {% else %}
                                <li>No products found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </li>
        {% else %}
            <li>No widget yet.</li>
        {% endfor %}
    </ul>

    <form id="dashboard-reorder-form" method="post" action="{{ path('dashboard_reorder') }}">
        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_reorder') }}">
        <input type="hidden" name="ordered_ids" id="dashboard-ordered-ids" value="">
        <button type="submit">Save order</button>
    </form>
</section>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
    (() => {
        const list = document.getElementById('dashboard-widgets-list');
        if (!list || typeof Sortable === 'undefined') {
            return;
        }

        new Sortable(list, {
            animation: 150
        });

        const form = document.getElementById('dashboard-reorder-form');
        form?.addEventListener('submit', function () {
            const ids = Array.from(list.querySelectorAll('[data-widget-id]')).map((el) => el.dataset.widgetId);
            document.getElementById('dashboard-ordered-ids').value = ids.join(',');
        });
    })();
</script>
