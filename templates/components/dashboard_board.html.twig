<section {{ attributes.defaults({ class: 'card' }) }}>
    <div class="row row-between">
        <h2 class="section-title">Widgets</h2>
        <span class="pill">Open Food Facts</span>
    </div>

    <div class="row row-mt">
        <form method="post" action="{{ path('dashboard_widget_add') }}">
            <input type="hidden" name="type" value="product_search">
            <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_add') }}">
            <button type="submit">Add product search</button>
        </form>
        <form method="post" action="{{ path('dashboard_widget_add') }}">
            <input type="hidden" name="type" value="brand_search">
            <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_add') }}">
            <button type="submit">Add brand search</button>
        </form>
        <form method="post" action="{{ path('dashboard_widget_add') }}">
            <input type="hidden" name="type" value="nutriscore_a_search">
            <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_add') }}">
            <button type="submit">Add NutriScore A finder</button>
        </form>
    </div>

    <p class="lead">Drag and drop widgets, then click "Save order".</p>

    <ul id="dashboard-widgets-list" class="widget-list">
        {% for widget in this.widgets %}
            <li data-widget-id="{{ widget.id }}" class="card card-compact">
                <div class="row row-between">
                    <strong>{{ widget.type }}</strong>
                    <span class="pill">#{{ widget.position }}</span>
                </div>

                <div class="row row-end space-top">
                    <form method="post" action="{{ path('dashboard_widget_configure', { widgetId: widget.id }) }}" class="row form-grow">
                        <div class="stack stack-tight field-grow">
                            <label for="config-{{ widget.id }}">{{ widget.configField.label }}</label>
                            <input
                                name="{{ widget.configField.name }}"
                                id="config-{{ widget.id }}"
                                type="text"
                                placeholder="{{ widget.configField.placeholder }}"
                                value="{{ attribute(widget.configuration, widget.configField.name)|default('') }}"
                            >
                        </div>
                        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_configure_' ~ widget.id) }}">
                        <button type="submit">Save config</button>
                    </form>

                    <form method="post" action="{{ path('dashboard_widget_remove', { widgetId: widget.id }) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_widget_remove_' ~ widget.id) }}">
                        <button type="submit">Remove</button>
                    </form>
                </div>

                {% set hasPreviewConfig = (widget.type == 'brand_search' and widget.configuration.brand is defined and widget.configuration.brand is not empty)
                    or (widget.type != 'brand_search' and widget.configuration.query is defined and widget.configuration.query is not empty) %}
                {% if hasPreviewConfig %}
                    <div class="card card-subtle">
                        <p class="lead lead-tight">
                            {% if widget.type == 'brand_search' %}
                                Brand results for "{{ widget.configuration.brand }}"
                            {% elseif widget.type == 'nutriscore_a_search' %}
                                NutriScore A results for "{{ widget.configuration.query }}"
                            {% else %}
                                Results for "{{ widget.configuration.query }}"
                            {% endif %}
                            {% if widget.degraded %}
                                <span class="degraded-note">(degraded: {{ widget.degradationReason }})</span>
                            {% endif %}
                        </p>

                        <ul class="results-list">
                            {% for product in widget.preview %}
                                <li>{{ product.name }}{% if product.brand %} - {{ product.brand }}{% endif %}{% if product.nutriScore %} (NutriScore: {{ product.nutriScore|upper }}){% endif %}</li>
                            {% else %}
                                <li>No products found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </li>
        {% else %}
            <li class="card">No widget yet.</li>
        {% endfor %}
    </ul>

    <form id="dashboard-reorder-form" method="post" action="{{ path('dashboard_reorder') }}" class="row space-top">
        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_reorder') }}">
        <input type="hidden" name="ordered_ids" id="dashboard-ordered-ids" value="">
        <button type="submit">Save order</button>
    </form>
</section>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
    (() => {
        const list = document.getElementById('dashboard-widgets-list');
        if (!list || typeof Sortable === 'undefined') {
            return;
        }

        new Sortable(list, {
            animation: 150
        });

        const form = document.getElementById('dashboard-reorder-form');
        form?.addEventListener('submit', function () {
            const ids = Array.from(list.querySelectorAll('[data-widget-id]')).map((el) => el.dataset.widgetId);
            document.getElementById('dashboard-ordered-ids').value = ids.join(',');
        });
    })();
</script>
